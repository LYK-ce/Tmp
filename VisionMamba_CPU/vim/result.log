================================================================================
Vision Mamba CPU推理性能测试 - 对比三种Selective Scan实现
================================================================================

测试时间: 2026-01-06 12:20:57
平台: AMD64

环境配置:
  PyTorch版本: 2.9.1+cu128
  Python版本: 3.13.5
  CPU线程数: 16
  SELECTIVE_SCAN_FORCE_FALLBACK: TRUE
  C++扩展: ✓ 可用

创建输入张量...
输入形状: torch.Size([1, 3, 224, 224])

================================================================================
步骤1: 创建基础模型并保存参数（确保所有测试使用相同参数）
================================================================================
✓ 基础模型参数已保存（参数量: 7.15M）

================================================================================
步骤2: 测试各种配置（使用相同的模型参数）
================================================================================
  全C++扩展: ✓ 可用

================================================================================
测试配置: Python-Original - Python原始实现（分离双向扫描）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: Python-Fixlen - Python两阶段实现（分离双向+fixlen优化）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: Python-Fused - Python融合实现（N维度concat批量计算）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: Python-Fused-Fixlen - Python融合+两阶段实现（双重优化）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: CPP-Original - C++原始实现（分离双向扫描）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: CPP-Fixlen - C++两阶段实现（分离双向+fixlen优化）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: CPP-Fused - C++融合实现（N维度concat批量计算）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: CPP-Fused-Fixlen - C++融合+两阶段实现（双重优化）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: FullCPP-Original - 全C++ Mamba实现（原始扫描）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: FullCPP-Fixlen - 全C++ Mamba实现（两阶段优化）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: FullCPP-Fused - 全C++ Mamba实现（融合双向）
================================================================================
✓ 已加载基础模型参数

================================================================================
测试配置: FullCPP-Fused-Fixlen - 全C++ Mamba实现（融合+两阶段）
================================================================================
✓ 已加载基础模型参数

================================================================================
输出一致性验证
================================================================================
Python-Fixlen vs Python-Original: 最大差异 = 7.75e-07 ✓ 一致
Python-Fused vs Python-Original: 最大差异 = 0.00e+00 ✓ 一致
Python-Fused-Fixlen vs Python-Original: 最大差异 = 8.94e-07 ✓ 一致
CPP-Original vs Python-Original: 最大差异 = 7.45e-07 ✓ 一致
CPP-Fixlen vs Python-Original: 最大差异 = 9.16e-07 ✓ 一致
CPP-Fused vs Python-Original: 最大差异 = 7.45e-07 ✓ 一致
CPP-Fused-Fixlen vs Python-Original: 最大差异 = 7.45e-07 ✓ 一致
FullCPP-Original vs Python-Original: 最大差异 = 9.98e-07 ✓ 一致
FullCPP-Fixlen vs Python-Original: 最大差异 = 1.04e-06 ✓ 一致
FullCPP-Fused vs Python-Original: 最大差异 = 9.98e-07 ✓ 一致
FullCPP-Fused-Fixlen vs Python-Original: 最大差异 = 9.98e-07 ✓ 一致

================================================================================
性能对比
================================================================================
配置                   时间(ms)       相对加速         说明
--------------------------------------------------------------------------------
Python-Original        866.22 ms     1.00x      
Python-Fixlen          645.05 ms     1.34x      ✓
Python-Fused           732.78 ms     1.18x      ✓
Python-Fused-Fixlen    363.41 ms     2.38x      ⭐
CPP-Original           517.48 ms     1.67x      ✓
CPP-Fixlen             331.48 ms     2.61x      ⭐
CPP-Fused              458.61 ms     1.89x      ✓
CPP-Fused-Fixlen       243.33 ms     3.56x      ⭐
FullCPP-Original       511.75 ms     1.69x      ✓
FullCPP-Fixlen         321.85 ms     2.69x      ⭐
FullCPP-Fused          231.79 ms     3.74x      ⭐
FullCPP-Fused-Fixlen   217.13 ms     3.99x      ⭐

================================================================================
测试总结
================================================================================
模型: Vim-tiny
参数量: 7.15M
输入尺寸: torch.Size([1, 3, 224, 224])
输出尺寸: torch.Size([1, 1000])
测试配置数: 12

生成的性能分析文件:
  - vim_python-original_profile.html
  - vim_python-fixlen_profile.html
  - vim_python-fused_profile.html
  - vim_python-fused-fixlen_profile.html
  - vim_cpp-original_profile.html
  - vim_cpp-fixlen_profile.html
  - vim_cpp-fused_profile.html
  - vim_cpp-fused-fixlen_profile.html
  - vim_fullcpp-original_profile.html
  - vim_fullcpp-fixlen_profile.html
  - vim_fullcpp-fused_profile.html
  - vim_fullcpp-fused-fixlen_profile.html

总耗时: 72.1秒
================================================================================

提示:
  1. 在浏览器中打开HTML文件查看详细性能分析
  2. 对比不同实现的selective_scan调用耗时
  3. 查看result.log获取完整测试报告

测试结果已保存到 result.log
